<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webpack-minimal</title>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon-16x16.png"/>
    <!-- <link rel="stylesheet" href="./src/index.css"/>
         <link rel="stylesheet" href="./src/theme.css"/> -->
    <link rel="stylesheet" href="./assets/cards-css/pixel.css"/>
    <link href="https://unpkg.com/ionicons@4.5.5/dist/css/ionicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <style>
          html, body {
         width: 100%;
         height: 100%;
         padding: 0px;
         margin: 0px;

     }

     body {
         font-family: 'Roboto', sans-serif;
         background: black;
     }

     section {
         width: 100%;
         height: 100%;
         background: #202020;
     }

     #controls {
         text-align: center;
     }

     .deck {
         display: flex;
         margin: auto;
         width: 90%;
         height: 30%;
     }

     .pg-wrap {
         margin: auto;
         width: 90%;
         height: 0;
         padding-bottom: 60%;
     }
    </style>
</head>
<body>
  <section>
    <div id="app"></div>

    <div id="controls">
      <button id="deal">Deal</button>
      <button id="round">Next Round</button>
      <button id="showdown">Showdown</button>
      <button id="showdown2">Showdown Muck</button>
      <button id="check">Check</button>
      <button id="call">Call</button>
      <button id="raise">Raise</button>
      <button id="allin">AllIn</button>
      <button id="fold">Fold</button>
    </div>
  </section>

  <section>
    <div class="is2d deck">
      <div class="card ace hearts"></div>
      <div class="card ace diamonds"></div>
      <div class="card ace clubs"></div>
      <div class="card ace spades"></div>
    </div>
  </section>

  <script>
   
   function init() {
     let pokerground;

     const handlers = {
       move(o) {
       }
     };

     function makeConfig(data) {
       return {
         round: data.round,
         deal: {
           blinds: data.blinds,
           button: data.button,
           smallBlind: data.smallBlind,
           bigBlind: data.bigBlind,
           firstToAct: data.firstToAct
         },
         currency: data.currency,
         pov: {
           seats: data.seats
         },
         events: {
         }
       };
     }

     const server = new Pokerground.Server();
     //const socket = new Pokerground.Socket(handlers);

     // const data = server.get();

     // pokerground = Pokerground(document.getElementById('app2'), makeConfig(data));
   }


   init();
  </script>

  <script>

   const promiseSerial = funcs =>
     funcs.reduce((promise, func) =>
       promise.then(result => func().then(Array.prototype.concat.bind(result))),
                  Promise.resolve([]))

   const api = init();

   function init() {
     
     const handlers = {
       move(o) {
       }
     };

     var config = {
       currency: '$',
       fen: '70b 50B 100!20(30 50 .)~10!0\nR20 R20',
       clock: {
         running: true,
         initial: 60,
         times: 60,
       },
       pov: {
         seats: [{img: 'https://i.pravatar.cc/300', idx: 0 },
                 { img: 'https://i.pravatar.cc/300', idx: 1 },
                 null,
                 null,
                 { img: 'https://i.pravatar.cc/300', idx: 2 }]
       },
       events: {
       }
     };

     //const server = new Pokerground.Server();
     //const socket = new Pokerground.Socket(handlers);

     const api = Pokerground(document.getElementById('app'), config);

     return api;
   }

   var seatIndexes = [0,1,2];
   const clock = { times: 30, initial: 30, running: true };
   
   const apiDelay = (delay = 1000) => {
     return new Promise(resolve => {
       setTimeout(resolve, delay);
     });
   };

   const apiDeal = (() => {
     var nextIndex = (from) => {
       return (from + 1) % seatIndexes.length;
     };
     var button = 0;
     return function() {
       button = nextIndex(button);
       return Promise.all([
         api.deal(button),
         api.setClock(clock)
       ]);
     }
   })();

   const apiShowdownMuck = (() => {
     var showdown = {
       pots: [
         { amount: 1500, involved: [seatIndexes[1]]}
       ],
       pot: 1000
     };
     return function() {
       return api.endRound(showdown);
     };
   })();

   const apiShowdown = (() => {
     var showdown = {
       middle: {
         flop: 'As Tc Qd',
         turn: 'Kh',
         river: '2c'
       },
       hands: {
         [seatIndexes[0]]: { hole: 'Ah Ac', rank: 'threepair', hand: 'Ah Ac As Qd Tc' },
         [seatIndexes[1]]: { hole: 'Kc Jh', rank: 'straight', hand: 'As Kh Qd Jh Tc' },
         [seatIndexes[2]]: { hole: '2c 3c', rank: 'highcard', hand: 'As Qd Tc 3c 2c' }
       },
       pots: [
         { amount: 1500, involved: [seatIndexes[1]]},
         { amount: 5000, involved: [seatIndexes[0], seatIndexes[2], seatIndexes[1]]},
         { amount: 1500, involved: [seatIndexes[1]]},
         { amount: 1500, involved: [seatIndexes[2]]},
         { amount: 1500, involved: [seatIndexes[0]]},
         { amount: 5000, involved: [seatIndexes[0], seatIndexes[2]]}],
       pot: 16000
     };
     return function() {
       return api.showdown(showdown);
     };
   })();

   const apiNextRound = (() => {
     var pot = 0;
     var middle = {};
     return function() {
       pot += 3250;
       var reset;
       if (middle.river) {
         middle = {};
         reset = true;
       }
       if (middle.turn) {
         middle.river = '2c'
       }
       if (middle.flop) {
         middle.turn = 'Kh'
       }
       if (!reset && !middle.flop) {
         middle.flop = 'As Tc Qd';
       }
       return api.nextRound({ middle, pot}).then(
         () => api.setClock(clock)
       );
     };
   })();

   function apiMove(o) {
     let lastPromise = api.move(o.uci);
     if (o.next) {
       lastPromise = lastPromise.then(apiNextRound);
     }
     if (o.showdown) {
       lastPromise = lastPromise.then(apiShowdown)
                                .then(apiDelay)
                                .then(apiDeal)
     }
     if (o.end) {
       lastPromise = lastPromise.then(apiShowdownMuck)
                                .then(() => apiDelay(2000))
                                .then(apiDeal);
     } else {
       lastPromise.then(() => api.setClock(o.clock));
     }
     return lastPromise;
   }

   onClick(document.getElementById("deal"), apiDeal);

   onClick(document.getElementById("showdown2"), apiShowdownMuck);
   
   onClick(document.getElementById("showdown"), apiShowdown);

   onClick(document.getElementById("round"), apiNextRound);

   onClick(document.getElementById("raise"), () => apiMove({
     uci: 'R10000',
     clock
   }));

   onClick(document.getElementById("call"), () => {
     apiMove({
       uci: 'C1000',
       clock,
       next: true
     })
   });

   onClick(document.getElementById("allin"), () => apiMove({
     uci: 'A10000',
     clock,
     showdown: true
   }));

   onClick(document.getElementById("check"), () => apiMove({
     uci: 'H',
     clock
   }));

   onClick(document.getElementById("fold"), () => apiMove({
     uci: 'F',
     clock,
     end: true
   }));

   function onClick(button, f) {
     button.addEventListener('click', f);
   }
   
  </script>

</body>
</html>
